var s=Snap("#surface"),g=s.group(),sel=s.group(),viewBox={x:0,y:0,width:0,height:0};function setViewBox(t,e,o,i){s.attr({viewBox:t+","+e+","+o+","+i})}function resize(){var t=$(window).width();t<=1024?(viewBox.width=1280,viewBox.height=1024,setViewBox(0,0,1280,1024)):t>1024&&(viewBox.width=2048,viewBox.height=1536,setViewBox(0,0,2048,1536))}resize(),$(window).resize(resize);var drag=!1,select=!1,changeColor=!1,clearColor=!1,changeColorData="",items=0,summ=0,price={1:1500,3:1500,5:1500,11:1500,12:1500,14:1500,18:1500,19:1500,23:1500,25:1500,26:1500,27:1500,29:1500,30:1500,32:1500,33:1500,35:1500,44:1500,45:1500,48:1500},count=1,elements=[];function rotate(t){var e=t.data("rotation");1==e?t.moveRotate(90,-136,0):t.moveRotate(90,136,0),t.data("rotation",!e)}function puzzleClick(){if(1==select&&this.toggleClass("selected"),1==changeColor&&0==clearColor){var t=s.image("img/"+changeColorData+".jpg",0,0,200,200).pattern(0,0,200,200);if(this.attr({fill:t,stroke:"#333"}),!(e=this.data("price"))){summ+=price[changeColorData],items+=1,this.data("price",price[changeColorData]),$("#price").text(summ),sel.append(this);sel.getBBox();calculateWidth()}}var e;0==changeColor&&1==clearColor&&(this.attr({fill:"transparent",stroke:"#ccc"}),(e=this.data("price"))&&(summ-=e,items-=1,this.removeData("price"),$("#price").text(summ),g.append(this),calculateWidth()),calculateWidth());return!1}function calculateWidth(){var t=sel.getBBox(),e=t.width/6.7,o=t.height/6.7;$("#size").text(e.toFixed(2)+"см x "+o.toFixed(2)+"см"),$("#count").text(items)}function initialize(){Snap.load("img/puzzle.svg",function(t){for(var e=t.select("g"),o=0;o<20;o++)for(var i=0;i<30;i++){var a=e.clone();a.attr({fill:"transparent",stroke:"#ccc",strokeWidth:1}),a.data("rotation",!0),a.data("id",count),a.data("bbox",a.getBBox()),a.click(puzzleClick),g.append(a);var n=viewBox.x+136*i-952,r=viewBox.y+136*o-680;a.move(Snap.snapTo(136,n,1e6),Snap.snapTo(136,r,1e6)),o%2==0&&a.rotateCenter(90),i%2==0&&a.rotateCenter(90),count+=1,elements.push(a)}}),$("#price").text(summ);sel.getBBox();calculateWidth()}Snap.plugin(function(t,e,o,i){e.prototype.altDrag=function(){return this.drag(n,a,r),this};var a=function(t,e,o){this.data("ot",this.transform().local)},n=function(e,o,i,a,n){var r,s,c=this.transform().diffMatrix.invert();if(c.e=c.f=0,r=c.x(e,o),s=c.y(e,o),1==this.data("rotation"))var l=t.snapTo(136,r,1e6),d=t.snapTo(136,s,1e6);else l=t.snapTo(136,r,1e6),d=t.snapTo(136,s,1e6);this.transform("t"+[l,d]+this.data("ot"))},r=function(t){}}),Snap.plugin(function(t,e,o,i){e.prototype.rotateCenter=function(e){var o=this.getBBox(),i=new t.Matrix;return i.rotate(e,o.cx,o.cy),i.add(this.transform().localMatrix),this.transform(i),this}}),Snap.plugin(function(t,e,o,i){e.prototype.move=function(e,o){this.getBBox();var i=new t.Matrix;return i.translate(e,o),i.add(this.transform().localMatrix),this.transform(i),this}}),Snap.plugin(function(t,e,o,i){e.prototype.moveRotate=function(e,o,i){var a=this.getBBox(),n=new t.Matrix;return n.translate(o,i),n.rotate(e,a.cx,a.cy),n.add(this.transform().localMatrix),this.transform(n),this}}),initialize(),addWheelListener(window,function(t){return t.preventDefault(),viewBox.x-=10*t.deltaY,viewBox.y-=10*t.deltaY,viewBox.width+=30*t.deltaY,viewBox.height+=30*t.deltaY,setViewBox(viewBox.x,viewBox.y,viewBox.width,viewBox.height),!1});var objzoom=document.getElementById("surface"),scaling=!1,dist=0,scale_factor=1,scale_fit=10,curr_scale=1,max_zoom=8,min_zoom=.5;function distance(t,e){return Math.sqrt(Math.pow(t.clientX-e.clientX,2)+Math.pow(t.clientY-e.clientY,2))}function selectColor(t,e){$(".selected-color").removeClass("selected-color"),$(e.target).addClass("selected-color"),"0"!==t?($("body").css({cursor:'url("img/'+t+'-cur.png"), auto'}),changeColorData=t,changeColor=!0,clearColor=!1):($("body").css({cursor:'url("img/clear-cur.png"), auto'}),changeColor=!1,clearColor=!0)}objzoom.addEventListener("touchstart",function(t){var e=t.touches;e.length>=2?(t.preventDefault(),dist=distance(e[0],e[1]),scaling=!0):scaling=!1},!1),objzoom.addEventListener("touchmove",function(t){t.preventDefault();var e=t.touches;if(scaling){var o=distance(e[0],e[1]),i=dist-o;viewBox.x-=i/15,viewBox.y-=i/15,viewBox.width+=i/5,viewBox.height+=i/5,setViewBox(viewBox.x,viewBox.y,viewBox.width,viewBox.height)}},!1),objzoom.addEventListener("touchend",function(t){var e=t.touches;if(e.length<2){scaling=!1;var o=distance(e[0],e[1]),i=dist-o;viewBox.x-=i,viewBox.y-=i,viewBox.width+=i,viewBox.height+=i,setViewBox(viewBox.x,viewBox.y,viewBox.width,viewBox.height)}else scaling=!0},!1),document.addEventListener("keydown",function(t){"Control"===t.key&&(select=!0)}),document.addEventListener("mousemove",function(t){1==drag&&(viewBox.x-=2*t.movementX,viewBox.y-=2*t.movementY,setViewBox(viewBox.x,viewBox.y,viewBox.width,viewBox.height))}),document.addEventListener("keyup",function(t){" "===t.key&&1==drag&&(drag=!1,document.body.style.cursor="auto"),"Control"===t.key&&(select=!1)}),$("#surface").focus();